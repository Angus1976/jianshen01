name: éƒ¨ç½² RocketBird åˆ° TCBï¼ˆå®¹å™¨å‹æœåŠ¡ï¼‰

on:
  push:
    branches: 
      - main
      - deploy
  workflow_dispatch:
    inputs:
      deployment_env:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ccr.ccs.tencentyun.com
  REGISTRY_NAMESPACE: rocketbird
  IMAGE_NAME: rocketbird-app
  TCB_ENV_ID: cloud1-4g2aaqb40446a63b

jobs:
  # 1. æ£€æŸ¥å’Œæ„å»ºé˜¶æ®µ
  setup:
    name: 'ğŸ” ç¯å¢ƒæ£€æŸ¥'
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.version.outputs.tag }}
      image_digest: ${{ steps.version.outputs.digest }}
    steps:
      - name: 'ğŸ“¥ æ£€å‡ºä»£ç '
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'ğŸ“Œ ç”Ÿæˆç‰ˆæœ¬æ ‡ç­¾'
        id: version
        run: |
          COMMIT_SHA=${{ github.sha }}
          SHORT_SHA=${COMMIT_SHA:0:7}
          BUILD_DATE=$(date -u +'%Y-%m-%d')
          BUILD_TIME=$(date -u +'%H:%M:%S')
          
          echo "tag=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "digest=${SHORT_SHA}-${BUILD_DATE}" >> $GITHUB_OUTPUT
          echo "build_time=${BUILD_DATE} ${BUILD_TIME}" >> $GITHUB_OUTPUT
          
          echo "âœ… ç‰ˆæœ¬æ ‡ç­¾: $SHORT_SHA"
          echo "âœ… æ„å»ºæ—¶é—´: ${BUILD_DATE} ${BUILD_TIME}"

  # 2. æ„å»ºå‰ç«¯ H5
  build-h5:
    name: 'ğŸ—ï¸ æ„å»º H5 å‰ç«¯'
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: 'ğŸ“¥ æ£€å‡ºä»£ç '
        uses: actions/checkout@v4

      - name: 'ğŸ“¦ è®¾ç½® Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'

      - name: 'ğŸ“¥ å®‰è£…ä¾èµ–'
        run: |
          yarn install --frozen-lockfile

      - name: 'ğŸ—ï¸ ç¼–è¯‘ H5'
        run: |
          cd packages/member-h5
          yarn build

      - name: 'ğŸ“¦ ç¼“å­˜ H5 æ„å»ºäº§ç‰©'
        uses: actions/cache/save@v4
        with:
          path: packages/member-h5/dist
          key: h5-build-${{ github.sha }}

  # 3. æ„å»ºç®¡ç†åå°
  build-admin:
    name: 'ğŸ—ï¸ æ„å»ºç®¡ç†åå°'
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: 'ğŸ“¥ æ£€å‡ºä»£ç '
        uses: actions/checkout@v4

      - name: 'ğŸ“¦ è®¾ç½® Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'

      - name: 'ğŸ“¥ å®‰è£…ä¾èµ–'
        run: |
          yarn install --frozen-lockfile

      - name: 'ğŸ—ï¸ ç¼–è¯‘ç®¡ç†åå°'
        run: |
          cd packages/admin
          yarn build

      - name: 'ğŸ“¦ ç¼“å­˜ç®¡ç†åå°æ„å»ºäº§ç‰©'
        uses: actions/cache/save@v4
        with:
          path: packages/admin/dist
          key: admin-build-${{ github.sha }}

  # 4. æ„å»ºåç«¯æœåŠ¡
  build-server:
    name: 'ğŸ—ï¸ æ„å»ºåç«¯æœåŠ¡'
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: 'ğŸ“¥ æ£€å‡ºä»£ç '
        uses: actions/checkout@v4

      - name: 'ğŸ“¦ è®¾ç½® Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'

      - name: 'ğŸ“¥ å®‰è£…ä¾èµ–'
        run: |
          yarn install --frozen-lockfile

      - name: 'ğŸ—ï¸ ç¼–è¯‘åç«¯æœåŠ¡'
        run: |
          cd packages/server
          yarn build

      - name: 'ğŸ“¦ ç¼“å­˜åç«¯æ„å»ºäº§ç‰©'
        uses: actions/cache/save@v4
        with:
          path: packages/server/dist
          key: server-build-${{ github.sha }}

  # 5. æ„å»ºå’Œæ¨é€ Docker é•œåƒ
  build-and-push-image:
    name: 'ğŸ³ æ„å»º Docker é•œåƒ'
    runs-on: ubuntu-latest
    needs: [setup, build-h5, build-admin, build-server]
    permissions:
      contents: read
      packages: write
    steps:
      - name: 'ğŸ“¥ æ£€å‡ºä»£ç '
        uses: actions/checkout@v4

      - name: 'ğŸ“¦ æ¢å¤ H5 æ„å»ºäº§ç‰©'
        uses: actions/cache/restore@v4
        with:
          path: packages/member-h5/dist
          key: h5-build-${{ github.sha }}

      - name: 'ğŸ“¦ æ¢å¤ç®¡ç†åå°æ„å»ºäº§ç‰©'
        uses: actions/cache/restore@v4
        with:
          path: packages/admin/dist
          key: admin-build-${{ github.sha }}

      - name: 'ğŸ“¦ æ¢å¤åç«¯æ„å»ºäº§ç‰©'
        uses: actions/cache/restore@v4
        with:
          path: packages/server/dist
          key: server-build-${{ github.sha }}

      - name: 'ğŸ”§ è®¾ç½® Docker Buildx'
        uses: docker/setup-buildx-action@v3

      - name: 'ğŸ” ç™»å½•è…¾è®¯äº‘ CCR'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.TENCENT_DOCKER_USERNAME }}
          password: ${{ secrets.TENCENT_DOCKER_PASSWORD }}

      - name: 'ğŸ·ï¸ å‡†å¤‡é•œåƒå…ƒæ•°æ®'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=${{ env.REGISTRY_NAMESPACE }}-
            type=semver,pattern={{version}}
            type=raw,value=latest

      - name: 'ğŸ³ æ„å»ºå’Œæ¨é€é•œåƒ'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ needs.setup.outputs.image_tag }}
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ needs.setup.outputs.image_digest }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ needs.setup.outputs.image_tag }}

      - name: 'ğŸ“Š é•œåƒæ„å»ºå®Œæˆ'
        run: |
          echo "âœ… é•œåƒå·²æˆåŠŸæ¨é€åˆ°è…¾è®¯äº‘ CCR"
          echo "ğŸ“ é•œåƒåœ°å€:"
          echo "   - ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ needs.setup.outputs.image_tag }}"
          echo "   - ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest"

  # 6. TCB éƒ¨ç½²
  deploy-to-tcb:
    name: 'ğŸš€ éƒ¨ç½²åˆ° TCB'
    runs-on: ubuntu-latest
    needs: [setup, build-and-push-image]
    environment:
      name: 'production'
      url: 'https://console.cloud.tencent.com/tcb'
    steps:
      - name: 'ğŸ“¥ æ£€å‡ºä»£ç '
        uses: actions/checkout@v4

      - name: 'ğŸ“¦ è®¾ç½® Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: 'ğŸ“¦ å®‰è£… TCB CLI'
        run: |
          npm install -g @cloudbase/cli

      - name: 'ğŸ” ç™»å½• TCB'
        run: |
          tcb login \
            --secretId '${{ secrets.TENCENT_SECRET_ID }}' \
            --secretKey '${{ secrets.TENCENT_SECRET_KEY }}'

      - name: 'ğŸ“‹ æŸ¥è¯¢ç°æœ‰æœåŠ¡'
        run: |
          echo "æŸ¥è¯¢ç¯å¢ƒ ${{ env.TCB_ENV_ID }} ä¸­çš„å®¹å™¨å‹æœåŠ¡..."
          tcb env:info --env-id ${{ env.TCB_ENV_ID }} || true

      - name: 'ğŸš€ éƒ¨ç½²å®¹å™¨å‹æœåŠ¡'
        run: |
          python3 scripts/deploy-tcb-container.py
        env:
          TCB_ENV_ID: ${{ env.TCB_ENV_ID }}
          TCB_SECRET_ID: ${{ secrets.TENCENT_SECRET_ID }}
          TCB_SECRET_KEY: ${{ secrets.TENCENT_SECRET_KEY }}

      - name: 'âœ… éƒ¨ç½²å®Œæˆ'
        run: |
          echo "ğŸ‰ å®¹å™¨é•œåƒå·²éƒ¨ç½²åˆ° TCB"
          echo "ğŸ“ æ§åˆ¶å°: https://console.cloud.tencent.com/tcb/env/${{ env.TCB_ENV_ID }}/service"
          echo "â³ è¯·åœ¨æ§åˆ¶å°åˆ›å»ºæˆ–æ›´æ–°å®¹å™¨å‹æœåŠ¡"

  # 7. éªŒè¯éƒ¨ç½²
  verify-deployment:
    name: 'âœ… éªŒè¯éƒ¨ç½²'
    runs-on: ubuntu-latest
    needs: [setup, deploy-to-tcb]
    if: success()
    steps:
      - name: 'ğŸ“¥ æ£€å‡ºä»£ç '
        uses: actions/checkout@v4

      - name: 'ğŸ“¦ è®¾ç½® Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: 'ğŸ“ ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š'
        run: |
          cat > deployment-report.md << 'EOF'
          # ğŸš€ RocketBird éƒ¨ç½²æŠ¥å‘Š
          
          ## éƒ¨ç½²ä¿¡æ¯
          - **é•œåƒ**: ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ needs.setup.outputs.image_tag }}
          - **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
          - **æäº¤ SHA**: ${{ github.sha }}
          - **åˆ†æ”¯**: ${{ github.ref_name }}
          
          ## æ„å»ºå†å²
          - H5 å‰ç«¯: âœ… æˆåŠŸ
          - ç®¡ç†åå°: âœ… æˆåŠŸ
          - åç«¯æœåŠ¡: âœ… æˆåŠŸ
          - Docker é•œåƒ: âœ… å·²æ¨é€
          - TCB éƒ¨ç½²: âœ… å·²å‘é€
          
          ## ä¸‹ä¸€æ­¥
          1. æ‰“å¼€ TCB æ§åˆ¶å°: https://console.cloud.tencent.com/tcb/env/${{ env.TCB_ENV_ID }}/service
          2. æŸ¥çœ‹å®¹å™¨å‹æœåŠ¡éƒ¨ç½²çŠ¶æ€
          3. è·å–æœåŠ¡è®¿é—® URL
          4. æµ‹è¯• API ç«¯ç‚¹
          
          ## æµ‹è¯•å‘½ä»¤
          ```bash
          # æ›¿æ¢ <service-url> ä¸ºå®é™…çš„æœåŠ¡ URL
          curl https://<service-url>/api/health
          curl https://<service-url>/h5
          curl https://<service-url>/admin
          ```
          
          EOF
          cat deployment-report.md

      - name: 'ğŸ“¤ ä¸Šä¼ éƒ¨ç½²æŠ¥å‘Š'
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: deployment-report.md

  # 8. æˆåŠŸé€šçŸ¥
  notify-success:
    name: 'ğŸ“¢ æˆåŠŸé€šçŸ¥'
    runs-on: ubuntu-latest
    needs: verify-deployment
    if: success()
    steps:
      - name: 'âœ… éƒ¨ç½²æˆåŠŸ'
        run: |
          echo "ğŸ‰ RocketBird éƒ¨ç½²æˆåŠŸï¼"
          echo ""
          echo "ğŸ“ å®¹å™¨é•œåƒ:"
          echo "   ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest"
          echo ""
          echo "ğŸ“ TCB æ§åˆ¶å°:"
          echo "   https://console.cloud.tencent.com/tcb/env/${{ env.TCB_ENV_ID }}/service"
          echo ""
          echo "â³ è¯·åœ¨ TCB æ§åˆ¶å°åˆ›å»ºæˆ–æ›´æ–°å®¹å™¨å‹æœåŠ¡"

  # 9. å¤±è´¥é€šçŸ¥
  notify-failure:
    name: 'ğŸ”” å¤±è´¥é€šçŸ¥'
    runs-on: ubuntu-latest
    if: failure()
    needs: [setup, build-h5, build-admin, build-server, build-and-push-image, deploy-to-tcb]
    steps:
      - name: 'âŒ éƒ¨ç½²å¤±è´¥'
        run: |
          echo "âŒ RocketBird éƒ¨ç½²å¤±è´¥"
          echo ""
          echo "è¯·æŸ¥çœ‹å·¥ä½œæµæ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯:"
          echo "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
