name: éƒ¨ç½² RocketBird åˆ° TCB å®¹å™¨å‹æœåŠ¡

on:
  push:
    branches:
      - main
      - deploy
  workflow_dispatch:

env:
  TCB_ENV_ID: cloud1-4g2aaqb40446a63b
  IMAGE_NAME: rocketbird-app
  REGISTRY: ccr.ccs.tencentyun.com
  REGISTRY_NAMESPACE: rocketbird

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      # 2. è®¾ç½® Node.js
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'yarn'

      # 3. å®‰è£…ä¾èµ–
      - name: å®‰è£…é¡¹ç›®ä¾èµ–
        run: yarn install --frozen-lockfile

      # 4. ç¼–è¯‘å‰ç«¯ (H5)
      - name: ç¼–è¯‘ H5 å‰ç«¯
        working-directory: packages/member-h5
        run: yarn build

      # 5. ç¼–è¯‘ç®¡ç†åå°
      - name: ç¼–è¯‘ç®¡ç†åå°
        working-directory: packages/admin
        run: yarn build

      # 6. ç¼–è¯‘åç«¯
      - name: ç¼–è¯‘åç«¯æœåŠ¡
        working-directory: packages/server
        run: yarn build

      # 7. è®¾ç½® Docker Buildx
      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 8. ç™»å½•è…¾è®¯äº‘ CCR
      - name: ç™»å½•è…¾è®¯äº‘å®¹å™¨ä»“åº“
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.TENCENT_DOCKER_USERNAME }}
          password: ${{ secrets.TENCENT_DOCKER_PASSWORD }}

      # 9. æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      - name: æ„å»ºå¹¶æ¨é€é•œåƒåˆ° CCR
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 10. é€šçŸ¥éƒ¨ç½²å®Œæˆ
      - name: éƒ¨ç½²å®Œæˆé€šçŸ¥
        if: success()
        run: |
          echo "âœ… Docker é•œåƒå·²æˆåŠŸæ¨é€åˆ°è…¾è®¯äº‘ CCR"
          echo "é•œåƒåœ°å€: ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest"
          echo ""
          echo "ğŸ“‹ åç»­æ­¥éª¤:"
          echo "1. åœ¨ TCB äº‘æ‰˜ç®¡æœåŠ¡ä¸­æ›´æ–°é•œåƒåœ°å€"
          echo "2. éƒ¨ç½²å®¹å™¨å‹æœåŠ¡"
          echo "3. éªŒè¯åº”ç”¨è®¿é—®"

      # 11. å¤±è´¥é€šçŸ¥
      - name: éƒ¨ç½²å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          exit 1
