# RocketBird å®¹å™¨å‹æœåŠ¡éƒ¨ç½²æŒ‡å—

## æ¦‚è¿°

æœ¬æŒ‡å—å±•ç¤ºå¦‚ä½•å°† RocketBird åº”ç”¨ä»**å‡½æ•°å‹æœåŠ¡**è¿ç§»åˆ°**å®¹å™¨å‹æœåŠ¡**éƒ¨ç½²ï¼Œè¿™æ ·å¯ä»¥ï¼š

- âœ… ä¸€ä¸ªå®¹å™¨åŒæ—¶è¿è¡Œå‰ç«¯ï¼ˆH5 + ç®¡ç†åå°ï¼‰å’Œåç«¯ API
- âœ… å®Œæ•´çš„ Node.js ç¯å¢ƒï¼Œæ—  10.15 ç‰ˆæœ¬é™åˆ¶
- âœ… ä½¿ç”¨ TCB æ–‡æ¡£å‹æ•°æ®åº“ä½œä¸ºæ•°æ®å­˜å‚¨
- âœ… æ›´çµæ´»çš„é…ç½®å’Œç¯å¢ƒå˜é‡æ”¯æŒ

---

## æ¶æ„å¯¹æ¯”

### å‡½æ•°å‹æœåŠ¡ï¼ˆåŸæ–¹æ¡ˆï¼‰
```
H5 å‰ç«¯  ----\
              |----> TCB äº‘å‡½æ•° (Node.js 10.15) -----> TCB æ•°æ®åº“
ç®¡ç†åå° ----/
API è¯·æ±‚
```

### å®¹å™¨å‹æœåŠ¡ï¼ˆæ–°æ–¹æ¡ˆï¼‰
```
H5 å‰ç«¯     ---|
ç®¡ç†åå°    ---|--> Docker å®¹å™¨ (Node.js 18+) -----> TCB æ•°æ®åº“
API è¯·æ±‚    ---|   - é™æ€æ–‡ä»¶æœåŠ¡
```

---

## éƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡ Dockerfile

å·²ä¸ºä½ åˆ›å»ºäº† `Dockerfile`ï¼Œè¯¥æ–‡ä»¶é‡‡ç”¨å¤šé˜¶æ®µæ„å»ºï¼š

```dockerfile
# ç¬¬ä¸€é˜¶æ®µ: æ„å»º H5 å‰ç«¯
# ç¬¬äºŒé˜¶æ®µ: æ„å»ºç®¡ç†åå°
# ç¬¬ä¸‰é˜¶æ®µ: æ„å»ºåç«¯ API
# æœ€ç»ˆé˜¶æ®µ: ç”Ÿäº§é•œåƒï¼ˆåŒ…å«æ‰€æœ‰å‰åç«¯ä»£ç ï¼‰
```

### ç¬¬äºŒæ­¥ï¼šæ„å»ºæœ¬åœ° Docker é•œåƒ

```bash
# æ–¹å¼ 1: ç›´æ¥æ„å»ºï¼ˆéœ€è¦å®‰è£… Dockerï¼‰
docker build -t rocketbird-app:latest -f Dockerfile .

# éªŒè¯é•œåƒæ˜¯å¦æˆåŠŸæ„å»º
docker images | grep rocketbird-app

# æœ¬åœ°æµ‹è¯•è¿è¡Œ
docker run -d -p 8000:8000 \
  -e TCB_ENV_ID=cloud1-4g2aaqb40446a63b \
  -e NODE_ENV=production \
  --name rocketbird-test \
  rocketbird-app:latest

# æµ‹è¯• API
curl http://localhost:8000/api/health

# è®¿é—® H5
open http://localhost:8000/h5

# è®¿é—®ç®¡ç†åå°
open http://localhost:8000/admin

# åœæ­¢å®¹å™¨
docker stop rocketbird-test && docker rm rocketbird-test
```

### ç¬¬ä¸‰æ­¥ï¼šæ¨é€é•œåƒåˆ°è…¾è®¯äº‘å®¹å™¨ä»“åº“

```bash
# 1. ç™»å½•è…¾è®¯äº‘ CCRï¼ˆå®¹å™¨é•œåƒæœåŠ¡ï¼‰
docker login ccr.ccs.tencentyun.com

# 2. æ ‡è®°é•œåƒ
docker tag rocketbird-app:latest ccr.ccs.tencentyun.com/rocketbird/rocketbird-app:latest

# 3. æ¨é€é•œåƒ
docker push ccr.ccs.tencentyun.com/rocketbird/rocketbird-app:latest
```

### ç¬¬å››æ­¥ï¼šåœ¨ TCB æ§åˆ¶å°åˆ›å»ºå®¹å™¨å‹æœåŠ¡

1. **æ‰“å¼€ TCB æ§åˆ¶å°**
   - https://console.cloud.tencent.com/tcb

2. **è¿›å…¥ã€Œäº‘æ‰˜ç®¡ã€**
   - å·¦ä¾§èœå• â†’ ã€Œäº‘æ‰˜ç®¡ã€â†’ ã€ŒæœåŠ¡ç®¡ç†ã€

3. **åˆ›å»ºæ–°æœåŠ¡**
   - ç‚¹å‡»ã€Œæ–°å»ºäº‘æ‰˜ç®¡æœåŠ¡ã€
   - å¡«å†™æœåŠ¡ä¿¡æ¯ï¼š
     - æœåŠ¡åï¼š`rocketbird-api`
     - éƒ¨ç½²æ–¹å¼ï¼šé€‰æ‹©ã€Œä½¿ç”¨é•œåƒã€
     - é•œåƒåœ°å€ï¼š`ccr.ccs.tencentyun.com/rocketbird/rocketbird-app:latest`
     - ç«¯å£ï¼š`8000`
     - CPUï¼š`500m`
     - å†…å­˜ï¼š`1GB`

4. **é…ç½®ç¯å¢ƒå˜é‡**
   - `NODE_ENV`: `production`
   - `TCB_ENV_ID`: `cloud1-4g2aaqb40446a63b`
   - `PORT`: `8000`
   - å…¶ä»–éœ€è¦çš„ç¯å¢ƒå˜é‡ï¼ˆä» .env.localï¼‰

5. **é…ç½®å¥åº·æ£€æŸ¥**
   - è·¯å¾„ï¼š`/api/health`
   - åˆå§‹å»¶è¿Ÿï¼š`5s`
   - è¶…æ—¶ï¼š`10s`
   - æ£€æŸ¥é—´éš”ï¼š`30s`

6. **éƒ¨ç½²**
   - ç‚¹å‡»ã€Œéƒ¨ç½²ã€æŒ‰é’®
   - ç­‰å¾…éƒ¨ç½²å®Œæˆï¼ˆé€šå¸¸ 2-5 åˆ†é’Ÿï¼‰

### ç¬¬äº”æ­¥ï¼šé…ç½® HTTP è®¿é—®

1. **è·å–æœåŠ¡ URL**
   - éƒ¨ç½²å®Œæˆåï¼ŒTCB ä¼šåˆ†é…ä¸€ä¸ªå…¬ç½‘ URL

2. **é…ç½®è‡ªå®šä¹‰åŸŸåï¼ˆå¯é€‰ï¼‰**
   - åœ¨ã€ŒåŸŸåç®¡ç†ã€ä¸­æ·»åŠ è‡ªå®šä¹‰åŸŸå

3. **æµ‹è¯•æœåŠ¡**
   ```bash
   # æ›¿æ¢ <tcb-domain> ä¸ºå®é™…çš„æœåŠ¡ URL
   curl https://<tcb-domain>/api/health
   ```

---

## éªŒè¯éƒ¨ç½²

### API æµ‹è¯•
```bash
# å¥åº·æ£€æŸ¥
curl https://<tcb-domain>/api/health

# ç™»å½•æµ‹è¯•
curl -X POST https://<tcb-domain>/api/auth/password-login \
  -H 'Content-Type: application/json' \
  -d '{"phone":"13800000001","password":"123456"}'
```

### å‰ç«¯è®¿é—®
- **H5 åº”ç”¨**: https://&lt;tcb-domain&gt;/h5
- **ç®¡ç†åå°**: https://&lt;tcb-domain&gt;/admin
- **é»˜è®¤é¦–é¡µ**: https://&lt;tcb-domain&gt;/ (é‡å®šå‘åˆ° H5)

---

## å®¹å™¨å‹æœåŠ¡ä¼˜åŠ¿

| ç‰¹æ€§ | å‡½æ•°å‹ | å®¹å™¨å‹ |
|------|--------|--------|
| Node.js ç‰ˆæœ¬ | ä»… 10.15 | ä»»æ„ç‰ˆæœ¬ |
| æ„å»ºæ—¶é—´ | å¿« | è¾ƒæ…¢ |
| å†·å¯åŠ¨ | æ¯«ç§’çº§ | ç§’çº§ |
| å†…å­˜é™åˆ¶ | 512MB | å¯é…ç½® |
| é™æ€æ–‡ä»¶ | ä¸æ”¯æŒ | æ”¯æŒ |
| è‡ªå®šä¹‰ä¾èµ– | æœ‰é™åˆ¶ | æ— é™åˆ¶ |
| æˆæœ¬ | æŒ‰è°ƒç”¨è®¡è´¹ | æŒ‰ CPU/å†…å­˜/æ—¶é—´ |

---

## æ•…éšœæ’é™¤

### å®¹å™¨æ— æ³•å¯åŠ¨
```bash
# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
# TCB æ§åˆ¶å° â†’ äº‘æ‰˜ç®¡ â†’ æœåŠ¡è¯¦æƒ… â†’ æ—¥å¿—

# æœ¬åœ°æµ‹è¯•é•œåƒ
docker run -it --rm rocketbird-app:latest

# æŸ¥çœ‹é•œåƒè¯¦æƒ…
docker inspect rocketbird-app:latest
```

### é•œåƒæ„å»ºå¤±è´¥
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
docker build -t rocketbird-app:latest -f Dockerfile . --progress=plain

# æ¸…ç†æ—§é•œåƒ
docker rmi rocketbird-app:latest

# é‡æ–°æ„å»º
docker build -t rocketbird-app:latest -f Dockerfile .
```

### æ•°æ®åº“è¿æ¥é”™è¯¯
- ç¡®ä¿ `TCB_ENV_ID` ç¯å¢ƒå˜é‡æ­£ç¡®
- éªŒè¯ TCB æ–‡æ¡£å‹æ•°æ®åº“å·²åˆ›å»º
- æ£€æŸ¥äº‘å‡½æ•°/å®¹å™¨çš„æƒé™é…ç½®

### å‰ç«¯èµ„æº 404
- ç¡®ä¿ Dockerfile æ­£ç¡®å¤åˆ¶äº†å‰ç«¯æ„å»ºäº§ç‰©
- éªŒè¯ Express é™æ€æ–‡ä»¶è·¯ç”±é…ç½®æ­£ç¡®
- æ£€æŸ¥ H5 å’Œç®¡ç†åå°çš„æ„å»ºè¾“å‡ºç›®å½•

---

## å›æ»šæ–¹æ¡ˆ

å¦‚éœ€å›é€€åˆ°å‡½æ•°å‹æœåŠ¡ï¼š

```bash
# åˆ é™¤å®¹å™¨å‹æœåŠ¡
# TCB æ§åˆ¶å° â†’ äº‘æ‰˜ç®¡ â†’ åˆ é™¤æœåŠ¡

# é‡æ–°éƒ¨ç½²å‡½æ•°å‹æœåŠ¡
bash scripts/deploy-function.sh
```

---

## ä¸‹ä¸€æ­¥

1. âœ… æœ¬åœ°éªŒè¯å®¹å™¨å¯æ­£å¸¸è¿è¡Œ
2. âœ… æ¨é€é•œåƒåˆ°è…¾è®¯äº‘å®¹å™¨ä»“åº“
3. âœ… åœ¨ TCB åˆ›å»ºå®¹å™¨å‹æœåŠ¡
4. âœ… é…ç½®è‡ªå®šä¹‰åŸŸå
5. âœ… ç›‘æ§æœåŠ¡çŠ¶æ€å’Œæ€§èƒ½

---

**éƒ¨ç½²å®Œæˆåï¼Œåº”ç”¨å°† 100% å°±ç»ªï¼** ğŸš€
